# Руководство пользователя по работе с MCP-сервером и Figma-плагином

## Содержание

1. [Введение](#введение)
2. [Установка и настройка](#установка-и-настройка)
3. [Интерфейс плагина](#интерфейс-плагина)
4. [Основные инструменты](#основные-инструменты)
5. [Шаг за шагом: первый проект](#шаг-за-шагом-первый-проект)
6. [Советы и лучшие практики](#советы-и-лучшие-практики)
7. [Устранение неполадок](#устранение-неполадок)
8. [Дополнительные ресурсы](#дополнительные-ресурсы)

## Введение

Данный инструмент представляет собой интеграцию между Figma и AI-моделями через MCP-сервер (Model Context Protocol), что позволяет:
- Анализировать дизайн с точки зрения UX/UI, доступности и соответствия дизайн-системе
- Генерировать адаптивные макеты для различных устройств
- Создавать варианты компонентов на основе текстового описания
- Генерировать код компонентов для различных фреймворков

Система состоит из двух основных частей:
1. **MCP-сервер** - серверная часть, обрабатывающая запросы и взаимодействующая с AI-моделями
2. **Figma-плагин** - интерфейс для взаимодействия с функциональностью MCP-сервера из Figma

## Установка и настройка

### Предварительные требования

Перед началом работы убедитесь, что у вас есть:
- Python 3.9+ (для MCP-сервера)
- Node.js 14+ (для сборки Figma-плагина)
- Аккаунт Figma
- Ключ API OpenAI
- Figma Personal Access Token

### Установка MCP-сервера

1. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/your-repo/figma-mcp-integration.git
   cd figma-mcp-integration
   ```

2. Запустите скрипт настройки окружения:
   ```bash
   cd scripts
   python setup_environment.py
   ```
   Скрипт проведет вас через процесс настройки и запросит необходимые API-ключи.

3. Альтернативный способ настройки (ручной):
   - Создайте файл `.env` в корневой директории проекта
   - Заполните его по образцу:
     ```
     # Figma API
     FIGMA_ACCESS_TOKEN=ваш_figma_token

     # OpenAI API
     OPENAI_API_KEY=ваш_openai_key

     # Портальные настройки
     MCP_PORT=5000
     WEBSOCKET_PORT=8765

     # Конфигурация логирования
     LOG_LEVEL=INFO
     LOG_FILE=logs/mcp_server.log

     # Для производственного режима
     TESTING_MODE=false
     ```

### Установка и настройка Figma-плагина

1. В Figma выберите меню **Plugins** → **Development** → **Import plugin from manifest**
2. Выберите файл `figma_plugin/manifest.json` из клонированного репозитория
3. Плагин будет добавлен в ваше меню разработки плагинов

## Интерфейс плагина

### Запуск и подключение

1. Сначала запустите MCP-сервер:
   ```bash
   cd scripts
   python run_example.py
   ```
   или вручную:
   ```bash
   cd mcp_server
   python server.py
   ```

2. Откройте Figma и запустите плагин:
   **Plugins** → **Development** → **[Название вашего плагина]**

3. Интерфейс плагина откроется с панелью инструментов и индикатором соединения.
   - **Зеленый индикатор**: соединение с MCP-сервером установлено
   - **Красный индикатор**: соединение отсутствует
   - **Желтый индикатор**: соединение устанавливается

### Основные разделы интерфейса

1. **Header** - верхняя панель с индикатором соединения и кнопкой настроек
2. **Connection Panel** - панель для управления подключением к серверу
3. **Tool Selector** - панель выбора инструментов (анализ, генерация кода и т.д.)
4. **Tool Configuration** - настройки выбранного инструмента
5. **Action Area** - кнопки действий и дополнительные опции
6. **Results Panel** - область отображения результатов
7. **Debug Panel** - интерактивная панель для мониторинга событий и отладки (можно скрыть/показать)

### Навигация по интерфейсу

- Для смены инструмента используйте панель **Tool Selector**
- Настройки отображаются автоматически в зависимости от выбранного инструмента
- Результаты анализа или генерации отображаются в панели **Results Panel**
- Для копирования результатов используйте кнопку **Copy** в правом верхнем углу панели результатов
- Для отображения/скрытия панели отладки используйте кнопку **Toggle Debug Panel**

### Панель отладки (Debug Panel)

Интерактивная панель для мониторинга событий и отладки процесса работы плагина:

1. **Отображение событий**: 
   - Показывает все события обмена между плагином и сервером
   - Логирует системные события и ошибки
   - Отслеживает время выполнения операций

2. **Управление видимостью**:
   - Кнопка **Toggle Debug Panel** скрывает/показывает панель
   - Настройка сохраняется между сессиями в localStorage

3. **Информация о соединении**:
   - Статус соединения (Connected/Disconnected)
   - URL сервера
   - Время установки соединения

### Тестирование соединения

Плагин включает инструменты для тестирования и проверки соединения с сервером:

1. **Тест PING/PONG**:
   - Кнопка **Test Ping** отправляет PING-сообщение на сервер
   - Система ожидает PONG-ответ от сервера
   - В панели отладки отображается результат и время отклика (латентность)
   - Зеленый индикатор: тест пройден успешно
   - Красный индикатор: ошибка теста или таймаут

2. **Тест обновления узла**:
   - Кнопка **Test Node Update** проверяет возможность обновления выбранного элемента
   - Необходимо выбрать элемент на холсте перед запуском теста
   - Система отправляет команду UPDATE_NODE на сервер
   - Сервер обрабатывает команду и отправляет обновление обратно в плагин
   - Элемент обновляется в соответствии с тестовыми параметрами
   - В панели отладки отображается весь процесс выполнения теста

3. **Автоматизированное тестирование**:
   - Кнопки **Start Automated Test** и **Stop Automated Test** для запуска и остановки серии тестов
   - Тесты выполняются с заданным интервалом
   - Результаты всех тестов отображаются в панели отладки
   - Полезно для проверки стабильности соединения при длительной работе

### Информация о выбранных элементах

- При выборе элементов на холсте Figma плагин автоматически собирает информацию о них
- Данные о выбранных элементах отображаются в панели отладки с меткой "SELECTION_INFO"
- Эта информация используется при выполнении операций анализа и генерации

## Основные инструменты

### Анализ дизайна (Design Analysis)

Этот инструмент анализирует выбранные элементы дизайна и предоставляет рекомендации по улучшению.

#### Как использовать:
1. Выберите один или несколько элементов в Figma
2. В плагине выберите инструмент **Analyze Design**
3. Выберите типы анализа:
   - General Analysis (общий анализ)
   - UX/UI Analysis (анализ интерфейса)
   - Accessibility Analysis (анализ доступности)
   - Design System Compliance (соответствие дизайн-системе)
4. Нажмите **Run Analysis**
5. Результаты появятся в панели результатов, структурированные по категориям

#### Настройки:
- **Analysis Depth**: глубина анализа (базовый, стандартный, глубокий)
- **Include Screenshots**: включить скриншоты элементов в отчет
- **Format**: формат вывода (JSON, HTML, Markdown)

### Генерация кода (Code Generation)

Этот инструмент генерирует код на основе выбранных элементов дизайна.

#### Как использовать:
1. Выберите один компонент или фрейм в Figma
2. В плагине выберите инструмент **Generate Code**
3. Настройте параметры генерации:
   - Framework (React, Vue, HTML/CSS)
   - Styling (CSS, Tailwind, Styled Components)
   - TypeScript support
   - Responsive design
4. Нажмите **Generate Code**
5. Сгенерированный код появится в панели результатов
6. Используйте кнопку **Copy** для копирования кода

#### Настройки:
- **Framework**: целевой фреймворк
- **Style System**: система стилей
- **TypeScript**: включить поддержку TypeScript
- **Responsive**: включить адаптивность
- **Accessibility**: уровень поддержки доступности

### Адаптивные макеты (Responsive Layout)

Этот инструмент создает адаптивные версии выбранного макета для различных устройств.

#### Как использовать:
1. Выберите фрейм с десктопным макетом в Figma
2. В плагине выберите инструмент **Generate Responsive Layout**
3. Выберите целевые устройства:
   - Tablet (768px)
   - Mobile Large (425px)
   - Mobile Small (320px)
4. Настройте стратегию адаптации
5. Нажмите **Generate**
6. В Figma будут созданы новые фреймы с адаптивными версиями макета

#### Настройки:
- **Target Devices**: целевые устройства
- **Adaptation Strategy**: стратегия адаптации (stack, shrink, hide)
- **Min Touch Target**: минимальный размер интерактивных элементов
- **Preserve Proportions**: сохранять пропорции элементов
- **Output Location**: расположение созданных фреймов

### Генерация вариантов (Variant Generation)

Этот инструмент создает несколько вариантов компонента на основе текстового описания.

#### Как использовать:
1. В плагине выберите инструмент **Generate Component Variants**
2. Введите текстовое описание компонента
3. Выберите количество вариантов (1-5)
4. При необходимости, укажите контекст дизайн-системы
5. Нажмите **Generate Variants**
6. В Figma будут созданы новые фреймы с вариантами компонента

#### Настройки:
- **Number of Variants**: количество вариантов (1-5)
- **Design System Context**: контекст дизайн-системы
- **Style Direction**: направление стиля (минималистичный, детальный, и т.д.)
- **Output Location**: расположение созданных фреймов

## Шаг за шагом: первый проект

### Проект 1: Анализ и улучшение кнопки

В этом проекте мы создадим кнопку, проанализируем ее дизайн, улучшим на основе рекомендаций и сгенерируем код.

#### Шаг 1: Создание кнопки
1. В Figma создайте новый фрейм (Shortcut: F)
2. Создайте прямоугольник размером 120x40px
3. Добавьте скругление углов (4px)
4. Установите заливку #3B82F6 (синий)
5. Добавьте текст "Button" белого цвета
6. Центрируйте текст внутри прямоугольника

#### Шаг 2: Анализ дизайна
1. Выберите созданную кнопку
2. В плагине выберите **Analyze Design**
3. Выберите типы анализа: **UX/UI Analysis** и **Accessibility Analysis**
4. Нажмите **Run Analysis**
5. Изучите результаты и рекомендации

#### Шаг 3: Улучшение дизайна
1. Внесите изменения на основе рекомендаций:
   - Увеличьте размер кнопки до 130x48px для лучшей кликабельности
   - Добавьте состояние наведения (:hover) с немного более темным оттенком
   - Убедитесь, что контраст текста и фона соответствует стандартам WCAG
   - Добавьте небольшую тень для улучшения восприятия глубины

2. Повторно проанализируйте кнопку, чтобы убедиться, что проблемы устранены

#### Шаг 4: Генерация кода
1. Выберите улучшенную кнопку
2. В плагине выберите **Generate Code**
3. Выберите настройки:
   - Framework: React
   - Styling: Tailwind CSS
   - TypeScript: Yes
   - Responsive: No (для простой кнопки не требуется)
   - Accessibility: Standard
4. Нажмите **Generate Code**
5. Скопируйте сгенерированный код и сохраните его

#### Шаг 5: Использование кода
1. Код можно использовать в любом React-проекте с Tailwind CSS
2. Компонент будет иметь входные параметры для настройки текста, действия и состояния кнопки

### Проект 2: Создание адаптивного заголовка страницы

В этом проекте мы создадим заголовок страницы и сгенерируем его адаптивные версии.

#### Шаг 1: Создание заголовка
1. В Figma создайте новый фрейм шириной 1280px и высотой 80px
2. Добавьте логотип слева (или текст в качестве логотипа)
3. Создайте меню с 5 пунктами посередине
4. Добавьте кнопку "Login" справа
5. Стилизуйте элементы в соответствии с вашим дизайном

#### Шаг 2: Генерация адаптивных версий
1. Выберите созданный заголовок
2. В плагине выберите **Generate Responsive Layout**
3. Выберите целевые устройства:
   - Tablet (768px)
   - Mobile Large (425px)
4. Настройте стратегию адаптации:
   - Для планшета: умеренное уменьшение размеров и отступов
   - Для мобильного: преобразование меню в "бургер"
5. Нажмите **Generate**
6. Изучите созданные адаптивные версии

#### Шаг 3: Доработка адаптивных версий
1. Внесите необходимые коррективы в созданные версии:
   - Уточните размеры элементов
   - Проверьте читаемость текста
   - Убедитесь, что интерактивные элементы имеют достаточный размер для мобильных устройств

#### Шаг 4: Генерация кода компонента
1. Выберите все три версии заголовка (десктоп, планшет, мобильный)
2. В плагине выберите **Generate Code**
3. Выберите настройки:
   - Framework: React
   - Styling: Tailwind CSS
   - TypeScript: Yes
   - Responsive: Yes
4. Нажмите **Generate Code**
5. Изучите сгенерированный адаптивный компонент

## Советы и лучшие практики

### Оптимальная организация дизайна

1. **Используйте компоненты**: Создавайте компоненты для повторно используемых элементов
2. **Групировка элементов**: Объединяйте связанные элементы в группы
3. **Именование**: Используйте понятные и последовательные имена для фреймов и слоев
4. **Auto Layout**: Применяйте Auto Layout для создания адаптивных элементов
5. **Дизайн-токены**: Используйте стили Figma для цветов, текста и эффектов

### Эффективная работа с AI-инструментами

1. **Конкретные запросы**: Чем конкретнее запрос, тем лучше результат
2. **Контекст**: Предоставляйте контекст при генерации вариантов или кода
3. **Итерации**: Улучшайте результаты посредством итеративного подхода
4. **Разбивка**: Разбивайте сложные задачи на более простые части

### Оптимизация производительности

1. **Выбор элементов**: Выбирайте только те элементы, которые нужны для анализа
2. **Ограничение глубины**: Используйте настройку "Analysis Depth" для больших компонентов
3. **Кеширование**: Результаты анализа кешируются, повторный анализ будет быстрее
4. **Закрытие других приложений**: Для больших проектов закрывайте ресурсоемкие приложения

### Совместная работа в команде

1. **Документирование решений**: Документируйте решения и причины изменений
2. **Обмен результатами**: Используйте возможность экспорта результатов для обмена с командой
3. **Стандартизация**: Используйте одинаковые настройки при генерации кода
4. **Версионирование**: Создавайте версии компонентов перед значительными изменениями

## Устранение неполадок

### Проблемы соединения

1. **Плагин не может подключиться к серверу**
   - Убедитесь, что MCP-сервер запущен
   - Проверьте настройки брандмауэра и антивируса
   - Проверьте, что WebSocket URL в плагине правильный
   - Попробуйте использовать IP-адрес вместо localhost

2. **Соединение прерывается во время использования**
   - Проверьте стабильность вашего интернет-соединения
   - Проверьте, не блокируют ли WebSocket подключения средства безопасности
   - Увеличьте таймауты в настройках сервера

### Проблемы анализа

1. **Анализ не начинается или зависает**
   - Убедитесь, что выбраны корректные элементы в Figma
   - Проверьте логи сервера на наличие ошибок
   - Уменьшите глубину анализа для сложных компонентов
   - Проверьте наличие и правильность API-ключей

2. **Результаты анализа неполные или некорректные**
   - Проверьте, все ли необходимые элементы выбраны
   - Убедитесь, что элементы правильно структурированы
   - Попробуйте изменить настройки анализа
   - Проверьте, соответствует ли выбранная модель AI сложности задачи

### Проблемы генерации кода

1. **Код не генерируется или содержит ошибки**
   - Убедитесь, что выбран только один компонент или фрейм
   - Проверьте сложность компонента (слишком сложные компоненты могут быть проблематичны)
   - Проверьте правильность настроек генерации
   - Попробуйте упростить компонент или разбить его на части

2. **Сгенерированный код не соответствует дизайну**
   - Проверьте, что все элементы дизайна корректно структурированы
   - Убедитесь, что используются стандартные возможности Figma
   - Попробуйте использовать Auto Layout для улучшения структуры
   - Проверьте, что все цвета и шрифты правильно определены

### Общие проблемы

1. **Плагин или сервер аварийно завершается**
   - Проверьте логи сервера для выявления причины
   - Убедитесь, что у вас достаточно свободной памяти и ресурсов CPU
   - Перезапустите Figma и MCP-сервер
   - Проверьте наличие обновлений для плагина и сервера

2. **Медленная работа плагина**
   - Закройте неиспользуемые вкладки и приложения
   - Уменьшите количество открытых файлов в Figma
   - Попробуйте уменьшить размер анализируемых компонентов
   - Проверьте настройки оптимизации сервера

## Дополнительные ресурсы

### Документация
- [Полная документация по API](docs/API_DOCUMENTATION.md)
- [Руководство по AI-интеграции](docs/AI_INTEGRATION.md)
- [Примеры рабочих процессов](docs/WORKFLOW_GUIDE.md)
- [Развертывание на сервере](docs/DEPLOYMENT_GUIDE.md)

### Обучающие материалы
- [Видео-руководства (YouTube)](https://youtube.com/@figma-mcp-tutorials)
- [Галерея примеров](examples/)
- [Часто задаваемые вопросы](docs/FAQ.md)

### Сообщество и поддержка
- [GitHub Issues](https://github.com/your-repo/figma-mcp-integration/issues)
- [Discord-сообщество](https://discord.gg/figma-mcp)
- [Twitter](https://twitter.com/figma_mcp)

## FAQ: Часто задаваемые вопросы

### Проблемы с подключением

#### Вопрос: Я не могу подключиться к MCP-серверу из Figma-плагина. Что делать?

**Ответ:** Проверьте следующие моменты:

1. Убедитесь, что MCP-сервер запущен. Выполните команду:
   ```bash
   cd mcp_server && python server.py
   ```

2. Проверьте, что порт 8768 не занят другими процессами:
   ```bash
   lsof -i :8768
   ```

3. Если порт занят, но вы не видите запущенного сервера, остановите процессы:
   ```bash
   pkill -f "python server.py"
   ```

4. Убедитесь, что в плагине указан правильный адрес сервера: `ws://localhost:8768`

5. Проверьте, нет ли в консоли ошибок CORS (в этом случае может потребоваться настройка заголовков на сервере)

#### Вопрос: Плагин подключается к серверу, но не получает ответы на запросы генерации кода. Почему?

**Ответ:** Проверьте следующие моменты:

1. Просмотрите логи сервера на наличие сообщений:
   - `Received unknown message type: GENERATE_CODE_REQUEST` - это означает, что обработчик не зарегистрирован или тип сообщения не совпадает

2. Убедитесь, что вы выделили элемент в Figma перед отправкой запроса

3. Проверьте, что структура сообщения верна:
   ```javascript
   {
     "type": "GENERATE_CODE_REQUEST",
     "payload": {
       "designData": { /* данные о дизайне */ },
       "framework": "react",
       "cssFramework": "tailwind",
       "componentName": "MyComponent"
     }
   }
   ```

4. Может потребоваться перезапуск MCP-сервера, если он "застрял" или находится в неконсистентном состоянии

#### Вопрос: Генерация кода возвращает общие ошибки или стандартные шаблоны вместо адаптированного кода. Почему?

**Ответ:**
1. Проверьте логи MCP-сервера на наличие ошибок с шаблонами или промптами:
   - `Error rendering template generate_code.j2: Object of type Undefined is not JSON serializable` - это означает проблему с параметрами шаблона

2. Убедитесь, что LLM-адаптер (OpenAI) настроен правильно и имеет доступ к API

3. Проверьте, что выбранный элемент в Figma содержит достаточно информации для генерации (стили, свойства, вложенные элементы)

4. Попробуйте более простой элемент для проверки функциональности

### Расширенное использование

#### Вопрос: Можно ли использовать локальные модели вместо OpenAI для генерации кода?

**Ответ:** Да, система поддерживает различные LLM-адаптеры. Для использования локальной модели:

1. Настройте соответствующий адаптер в `config.py`:
   ```python
   "llm_config": {
     "adapter_type": "ollama",  # или другой поддерживаемый тип
     "model": "codellama",
     "endpoint": "http://localhost:11434"
   }
   ```

2. Обновите настройки в файле `.env`:
   ```
   LLM_ADAPTER=ollama
   LLM_MODEL=codellama
   LLM_ENDPOINT=http://localhost:11434
   ```

3. Перезапустите MCP-сервер для применения изменений

#### Вопрос: Как добавить поддержку новых фреймворков для генерации кода?

**Ответ:** Для добавления нового фреймворка:

1. Обновите шаблон `resources/prompts/generate_code.j2`, добавив инструкции для нового фреймворка в разделе "Особенности фреймворка":
   ```jinja2
   {% if framework == "your_framework" %}
   - Используйте компоненты и паттерны specific_framework
   - Следуйте стилистике framework_specific_style
   - Добавьте типизацию с TypeScript
   {% endif %}
   ```

2. Обновите логику в функции `generate_code` в `server.py`, чтобы поддерживать новое расширение файла:
   ```python
   file_extension = "jsx" if framework == "react" else "vue" if framework == "vue" else "svelte" if framework == "svelte" else "html"
   ```

3. Добавьте поддержку нового фреймворка в UI плагина в dropdown меню

---

Это руководство содержит основную информацию, необходимую для начала работы с MCP-сервером и Figma-плагином. По мере использования вы откроете для себя дополнительные возможности и сценарии применения. Если у вас возникнут вопросы, обратитесь к дополнительной документации или сообществу. 