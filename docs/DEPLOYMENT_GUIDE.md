# Руководство по развертыванию MCP-сервера

Это руководство поможет вам развернуть MCP-сервер для интеграции Figma с AI на локальной машине и настроить его для практического использования.

## Содержание

1. [Подготовка окружения](#подготовка-окружения)
2. [Установка и настройка MCP-сервера](#установка-и-настройка-mcp-сервера)
3. [Настройка Figma-плагина](#настройка-figma-плагина)
4. [Запуск и тестирование системы](#запуск-и-тестирование-системы)
5. [Первый практический кейс использования](#первый-практический-кейс-использования)
6. [Устранение типовых проблем](#устранение-типовых-проблем)

## Подготовка окружения

### Получение необходимых API-ключей

#### 1. OpenAI API Key

1. Посетите [OpenAI Platform](https://platform.openai.com/)
2. Зарегистрируйтесь или войдите в свою учетную запись
3. Перейдите в раздел [API Keys](https://platform.openai.com/account/api-keys)
4. Нажмите "Create new API key"
5. Придумайте название для ключа (например, "Figma MCP Integration")
6. Сохраните сгенерированный ключ в надежном месте

#### 2. Figma Personal Access Token

1. Войдите в свою учетную запись Figma
2. Перейдите в настройки аккаунта (Account Settings)
3. Перейдите на вкладку "Personal Access Tokens"
4. Нажмите "Create new token"
5. Введите название токена (например, "MCP Server")
6. Сохраните сгенерированный токен в надежном месте

> ⚠️ **Важно**: API-ключи предоставляют доступ к платным сервисам и вашим личным данным. Никогда не публикуйте их в публичных репозиториях, не передавайте третьим лицам и не включайте их в код, который будет доступен другим людям.

### Настройка хранения ключей

Для безопасного хранения ключей мы будем использовать файл `.env`, который не должен включаться в систему контроля версий.

1. Создайте файл `.env` в корневой директории проекта на основе `.env.example`:

```bash
cp .env.example .env
```

2. Отредактируйте файл `.env`, заменив заглушки на реальные значения ваших API-ключей:

```env
# Figma API
FIGMA_ACCESS_TOKEN=your_real_figma_access_token_here

# OpenAI API
OPENAI_API_KEY=your_real_openai_api_key_here

# Портальные настройки
MCP_PORT=5000
WEBSOCKET_PORT=8765

# Конфигурация логирования
LOG_LEVEL=INFO
LOG_FILE=logs/mcp_server.log

# Для производственного режима
TESTING_MODE=false
```

3. Убедитесь, что файл `.env` добавлен в `.gitignore`, чтобы избежать случайной публикации:

```bash
echo ".env" >> .gitignore
```

## Установка и настройка MCP-сервера

### Клонирование репозитория

```bash
git clone https://github.com/neprokin/vibedesign.git
cd vibedesign
```

### Настройка виртуального окружения Python

```bash
# Создание виртуального окружения
python -m venv venv

# Активация окружения на macOS/Linux
source venv/bin/activate

# Активация окружения на Windows
# venv\Scripts\activate
```

### Установка зависимостей

```bash
pip install -r requirements.txt
```

Если файл `requirements.txt` отсутствует или неполный, установите необходимые пакеты вручную:

```bash
pip install fastmcp openai websockets python-dotenv aiohttp jinja2 jsonschema pyyaml pytest pytest-asyncio
```

### Проверка конфигурации

```bash
cd mcp_server
python test_basic.py
```

Если все тесты прошли успешно, ваша базовая конфигурация работает корректно.

## Настройка Figma-плагина

### Создание и регистрация плагина

1. Войдите в [Figma](https://www.figma.com/)
2. Выберите любой проект
3. Нажмите на меню справа вверху и выберите "Plugins" → "Development" → "New Plugin"
4. Выберите шаблон "Create a new plugin" (или используйте существующий плагин из репозитория)
5. Введите название и описание плагина
6. Используйте содержимое папки `figma_plugin` из репозитория для вашего плагина

### Настройка соединения с MCP-сервером

Отредактируйте файл `figma_plugin/src/services/websocket.ts` (или аналогичный), установив правильный IP-адрес и порт:

```typescript
const SERVER_URL = "ws://localhost:8765";  // Измените на ваш IP, если необходимо
```

### Сборка плагина

```bash
cd figma_plugin
npm install
npm run build
```

### Загрузка плагина в Figma

1. В Figma выберите "Plugins" → "Development" → "Import plugin from manifest"
2. Выберите файл `figma_plugin/manifest.json` из репозитория
3. Плагин будет добавлен в ваш список разработки плагинов

## Запуск и тестирование системы

### Запуск MCP-сервера

```bash
cd mcp_server
python server.py
```

Вы увидите сообщение о том, что сервер запущен и слушает на указанных портах:
- MCP API на порту 5000
- WebSocket на порту 8765

### Запуск Figma-плагина

1. Откройте Figma и выберите или создайте файл для тестирования
2. Нажмите на меню справа вверху и выберите "Plugins" → "Development" → "Ваш плагин"
3. Интерфейс плагина должен открыться с подтверждением соединения с сервером

### Проверка соединения

Чтобы проверить, что соединение между плагином и сервером работает:

1. В интерфейсе плагина нажмите на кнопку "Check Connection" (или аналогичную)
2. Вы должны увидеть сообщение "Connected to MCP Server" (или аналогичное)
3. В консоли сервера должны появиться логи о подключении нового клиента

## Первый практический кейс использования

### Кейс 1: Анализ дизайна

Давайте проверим функциональность анализа дизайна:

1. Откройте файл Figma с некоторыми элементами дизайна
2. Выберите фрейм или группу элементов
3. В плагине выберите инструмент "Analyze Design"
4. Нажмите "Run Analysis"
5. Получите результаты анализа и рекомендации

### Кейс 2: Генерация кода компонента

Теперь проверим генерацию кода на основе выбранного компонента:

1. Выберите компонент или фрейм, для которого хотите сгенерировать код
2. В плагине выберите инструмент "Generate Code"
3. Выберите целевой фреймворк (React, Vue или HTML/CSS)
4. Нажмите "Generate"
5. Получите сгенерированный код и скопируйте его в свой проект

### Кейс 3: Создание адаптивного макета

Проверим функциональность создания адаптивных макетов:

1. Выберите фрейм с дизайном, ориентированным на десктоп
2. В плагине выберите инструмент "Generate Responsive Layout"
3. Выберите целевой размер экрана (например, Mobile)
4. Нажмите "Generate"
5. Получите адаптивную версию вашего макета

## Устранение типовых проблем

### Проблема: Плагин не может подключиться к серверу

**Решение**:
1. Убедитесь, что сервер запущен и работает
2. Проверьте настройки брандмауэра и антивируса
3. Проверьте, что адрес и порт в плагине соответствуют настройкам сервера
4. Попробуйте использовать `127.0.0.1` вместо `localhost`

### Проблема: Ошибки API-ключей

**Решение**:
1. Проверьте, что ваши API-ключи правильно указаны в файле `.env`
2. Проверьте, что файл `.env` находится в правильной директории
3. Перезапустите сервер после изменения файла `.env`
4. Проверьте статус ваших ключей в соответствующих панелях управления (OpenAI, Figma)

### Проблема: Ошибки в ответах от LLM

**Решение**:
1. Проверьте логи сервера для получения более подробной информации об ошибке
2. Убедитесь, что у вашего аккаунта OpenAI есть доступ к выбранной модели
3. Проверьте, что у вас достаточно средств на балансе OpenAI
4. Попробуйте изменить параметры запроса (temperature, max_tokens)

### Проблема: Медленная работа или таймауты

**Решение**:
1. Проверьте скорость вашего интернет-соединения
2. Уменьшите размер запросов, отправляемых в API OpenAI
3. Увеличьте таймауты в настройках сервера
4. Используйте более легкие модели для быстрых операций

## Дальнейшие шаги

- Изучите дополнительные возможности системы в документации
- Настройте шаблоны промптов под свои специфические задачи
- Подумайте о создании автоматизированных рабочих процессов для повторяющихся задач
- Собирайте и анализируйте обратную связь от пользователей для улучшения системы 