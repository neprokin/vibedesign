# Руководство по разработке Figma-плагина

## Содержание

1. [Обзор](#обзор)
2. [Архитектура плагина](#архитектура-плагина)
3. [Интерфейс пользователя](#интерфейс-пользователя)
4. [Коммуникация с MCP-сервером](#коммуникация-с-mcp-сервером)
5. [Реализация инструментов](#реализация-инструментов)
6. [Тестирование плагина](#тестирование-плагина)
7. [Рекомендации по разработке](#рекомендации-по-разработке)
8. [План разработки](#план-разработки)
9. [Репозиторий и ветки](#репозиторий-и-ветки)

## Репозиторий и ветки

### Информация о репозитории

Проект размещен в репозитории на GitHub и организован с использованием веток для различных этапов разработки.

- **Основной репозиторий**: [https://github.com/neprokin/vibe-design](https://github.com/neprokin/vibe-design)
- **Статус проекта**: Активная разработка
- **Лицензия**: MIT License

### Структура веток

Разработка ведется в следующих ветках:

1. **`main`** - основная ветка, содержит стабильный код
   - Текущее состояние: Базовая структура проекта и документация
   - Точка слияния для прошедших проверку функциональностей

2. **`feature/mcp-server`** - ветка разработки MCP-сервера
   - Текущее состояние: MCP-сервер полностью разработан с поддержкой WebSocket и API для Figma
   - Включает интеграцию с AI, инструменты анализа дизайна и генерации кода

3. **`feature/figma-plugin-development`** - ветка разработки плагина Figma
   - Текущее состояние: Плагин разработан и готов к тестированию
   - Реализована полная функциональность для всех инструментов
   - WebSocket-соединение с MCP-сервером для обмена данными
   - Настройки плагина и обработка выбранных элементов

4. **`dev`** - ветка для интеграции всех изменений перед слиянием с main
   - Текущее состояние: Синхронизирована с main

### Порядок работы с ветками

1. Разработка новых функций выполняется в тематических ветках:
   - `feature/имя-функциональности` - для новых функций
   - `bugfix/имя-ошибки` - для исправления ошибок
   - `hotfix/имя-срочного-исправления` - для срочных исправлений

2. После завершения разработки:
   - Выполняется код-ревью
   - Проводится тестирование
   - Создается Pull Request в `dev`

3. После проверки в `dev`:
   - Изменения тестируются в интеграции с другими компонентами
   - При успешном тестировании код переносится в `main`

### Текущие разработки

- **Активная разработка**: Тестирование и отладка Figma-плагина
- **Закрытые этапы**: Базовая инфраструктура, инструменты для работы с Figma, AI-интеграция, документация, разработка основных компонентов плагина
- **Следующие этапы**: Тестирование и отладка плагина, подготовка к выпуску

## Обзор

Figma-плагин является ключевым компонентом системы, обеспечивающим взаимодействие между Figma и MCP-сервером. Он предоставляет пользовательский интерфейс для доступа к различным инструментам анализа дизайна, генерации кода и других функций, которые обрабатываются на стороне MCP-сервера с использованием AI.

### Ключевые функции плагина

1. **Подключение к MCP-серверу**:
   - Установка и управление WebSocket-соединением
   - Обработка сетевых ошибок и повторные подключения
   - Индикация статуса соединения

2. **Управление дизайн-элементами**:
   - Получение информации о выбранных элементах
   - Отправка данных в MCP-сервер
   - Применение изменений к элементам дизайна

3. **Инструменты анализа и генерации**:
   - Анализ дизайна (UX/UI, доступность)
   - Генерация кода
   - Генерация адаптивных макетов
   - Генерация вариантов компонентов

4. **Пользовательский интерфейс**:
   - Панель инструментов
   - Настройки для каждого инструмента
   - Отображение результатов
   - Индикаторы прогресса

## Архитектура плагина

### Структура проекта

```
figma_plugin/
├── src/
│   ├── components/       # React-компоненты UI
│   │   ├── App.tsx       # Корневой компонент
│   │   ├── Header.tsx    # Заголовок с индикатором соединения
│   │   ├── Toolbar.tsx   # Панель инструментов
│   │   ├── Settings.tsx  # Панель настроек
│   │   └── Results.tsx   # Панель результатов
│   ├── services/         # Сервисы
│   │   ├── websocket.ts  # Сервис WebSocket
│   │   └── figma-api.ts  # Обертка для Figma API
│   ├── styles/           # Стили компонентов
│   │   └── main.css      # Основные стили CSS
│   ├── types.ts          # Типы и интерфейсы
│   ├── plugin.ts         # Код плагина (main)
│   └── ui.tsx            # Точка входа для UI
├── ui.html               # HTML для UI
├── manifest.json         # Манифест плагина
├── package.json          # Зависимости и скрипты
└── tsconfig.json         # Настройки TypeScript
```

### Архитектурные принципы

1. **Разделение ответственности**:
   - **plugin.ts** - логика на стороне Figma
   - **ui.tsx** - пользовательский интерфейс
   - **services/** - сервисы для работы с API
   - **components/** - компоненты UI

2. **Поток данных**:
   - Пользователь взаимодействует с UI
   - UI отправляет сообщения в plugin.ts через `postMessage`
   - plugin.ts обрабатывает сообщения и взаимодействует с Figma API
   - Результаты отправляются обратно в UI или в MCP-сервер
   - MCP-сервер возвращает результаты, которые отображаются в UI

## Интерфейс пользователя

### Основные компоненты UI

1. **Header**:
   - Название плагина
   - Индикатор соединения с MCP-сервером (зеленый/красный)
   - Кнопка настроек

2. **Toolbar**:
   - Набор кнопок для выбора инструментов
   - Визуальное выделение активного инструмента
   - Иконки для каждого инструмента

3. **Settings**:
   - Динамически меняется в зависимости от выбранного инструмента
   - Поля настроек и параметры для каждого инструмента
   - Кнопка "Применить" или "Запустить"

4. **Results**:
   - Отображение результатов анализа или генерации
   - Для анализа: структурированный отчет с рекомендациями
   - Для генерации кода: сгенерированный код с подсветкой синтаксиса
   - Для вариантов: превью сгенерированных вариантов
   - Кнопки "Копировать", "Применить" и т.д.

### Макет интерфейса

```
+--------------------------------------------+
| [Logo] Vibe Design             [Status] [⚙] |
+--------------------------------------------+
| [Analyze] [Code] [Responsive] [Variants]   |
+--------------------------------------------+
|                                            |
| Settings for the selected tool:            |
|                                            |
| [ ] Option 1                               |
| [ ] Option 2                               |
| [_____________________]                    |
|                                            |
| [Run Analysis]                             |
+--------------------------------------------+
|                                            |
| Results:                                   |
|                                            |
| +----------------------------------------+ |
| |                                        | |
| |                                        | |
| |                                        | |
| |                                        | |
| +----------------------------------------+ |
|                                            |
| [Copy] [Apply] [Save]                      |
+--------------------------------------------+
```

## Коммуникация с MCP-сервером

### WebSocket-протокол

Коммуникация между плагином и MCP-сервером осуществляется через WebSocket с использованием сообщений в формате JSON:

```typescript
interface WebSocketMessage {
  type: string;  // Тип сообщения
  payload: any;  // Данные сообщения
}
```

### Типы сообщений

1. **От плагина к серверу**:
   - `ANALYZE_DESIGN`: отправка данных дизайна для анализа
   - `GENERATE_CODE`: запрос на генерацию кода
   - `GENERATE_RESPONSIVE`: запрос на генерацию адаптивного макета
   - `GENERATE_VARIANTS`: запрос на генерацию вариантов компонента

2. **От сервера к плагину**:
   - `ANALYSIS_RESULT`: результаты анализа дизайна
   - `CODE_GENERATED`: сгенерированный код
   - `RESPONSIVE_GENERATED`: данные адаптивного макета
   - `VARIANTS_GENERATED`: данные вариантов компонента
   - `ERROR`: информация об ошибке

### Пример реализации отправки сообщения

```typescript
// В плагине
function analyzeDesign(figmaData: FigmaNodeData, options: AnalysisOptions) {
  webSocketClient.send('ANALYZE_DESIGN', {
    figmaData,
    options,
    sessionId: generateSessionId()
  });
}

// Обработка ответа
webSocketClient.on('ANALYSIS_RESULT', (payload) => {
  showAnalysisResults(payload);
});
```

## Реализация инструментов

### 1. Анализ дизайна

Инструмент для анализа дизайна с точки зрения UX/UI, доступности и соответствия дизайн-системе.

**Параметры**:
- Типы анализа (UX/UI, доступность, дизайн-система)
- Глубина анализа (базовый, стандартный, глубокий)
- Формат вывода (JSON, HTML, Markdown)

**Рабочий процесс**:
1. Выбор элемента(ов) для анализа
2. Выбор параметров анализа
3. Нажатие кнопки "Запустить анализ"
4. Получение результатов с рекомендациями по улучшению

### 2. Генерация кода

Инструмент для генерации кода для различных фреймворков на основе выбранного дизайна.

**Параметры**:
- Целевой фреймворк (React, Vue, HTML/CSS)
- Стили (CSS, Tailwind, Styled Components)
- Параметры (TypeScript, адаптивность и т.д.)

**Рабочий процесс**:
1. Выбор компонента для генерации кода
2. Выбор параметров генерации
3. Нажатие кнопки "Генерировать код"
4. Получение сгенерированного кода
5. Копирование или экспорт кода

### 3. Генерация адаптивных макетов

Инструмент для создания адаптивных версий макетов для различных размеров экрана.

**Параметры**:
- Целевые устройства (планшет, мобильный большой, мобильный малый)
- Стратегия адаптации (стекинг, сжатие, рефлоу)
- Минимальный размер целевых объектов
- Сохранение пропорций

**Рабочий процесс**:
1. Выбор макета для адаптации
2. Выбор параметров адаптации
3. Нажатие кнопки "Создать адаптивные макеты"
4. Получение адаптированных макетов
5. Применение изменений в Figma

### 4. Генерация вариантов компонентов

Инструмент для генерации вариантов дизайна компонентов с различными стилями.

**Параметры**:
- Описание компонента
- Количество вариантов
- Стиль (минималистичный, современный, креативный, корпоративный)
- Типы вариаций (цвет, размер)

**Рабочий процесс**:
1. Выбор компонента или создание описания нового компонента
2. Выбор параметров генерации
3. Нажатие кнопки "Создать варианты"
4. Получение вариантов компонента
5. Выбор и применение нужного варианта

## Тестирование плагина

### Настройка среды разработки

Для тестирования плагина в Figma выполните следующие шаги:

1. **Сборка плагина**:
   ```bash
   cd figma_plugin
   npm install
   npm run build
   ```

2. **Запуск MCP-сервера**:
   ```bash
   cd mcp_server
   python server.py
   ```

3. **Загрузка плагина в Figma**:
   - Откройте Figma Desktop
   - Перейдите в меню: Plugins > Development > New Plugin...
   - Выберите опцию "Link existing plugin"
   - Укажите путь к файлу manifest.json в папке figma_plugin

### Отладка плагина

Для отладки плагина в среде Figma:

1. **Режим разработки**:
   - Откройте Figma Desktop
   - Перейдите в меню: Plugins > Development > Vibe Design (ваш плагин)
   - При первом запуске может потребоваться подтверждение разрешений

2. **Консоль разработчика**:
   - При открытом плагине, нажмите правой кнопкой мыши на интерфейс плагина
   - Выберите "Inspect Element"
   - Перейдите во вкладку "Console"
   - Сообщения от плагина и ошибки будут отображаться здесь

3. **Обновление плагина после изменений**:
   - После изменений в коде выполните `npm run build`
   - В Figma перезапустите плагин через меню: Plugins > Development > Vibe Design

### Проверка функциональности

Для проверки функциональности плагина следуйте этим шагам:

1. **Проверка подключения**:
   - Запустите MCP-сервер
   - Откройте плагин в Figma
   - Нажмите кнопку "Connect" в заголовке
   - Проверьте, что статус соединения изменился на "Connected"

2. **Проверка инструментов**:
   - Создайте или выберите элементы в Figma
   - Выберите инструмент в панели инструментов
   - Настройте параметры
   - Нажмите кнопку запуска
   - Проверьте результаты в панели результатов

3. **Проверка управления настройками**:
   - Откройте настройки плагина
   - Измените URL MCP-сервера
   - Сохраните настройки
   - Перезапустите плагин и проверьте, что изменения сохранились

### Типичные проблемы и решения

1. **Проблемы соединения с WebSocket**:
   - Убедитесь, что MCP-сервер запущен
   - Проверьте URL в настройках плагина
   - Проверьте наличие ошибок в консоли разработчика
   - Проверьте, не блокирован ли порт брандмауэром

2. **Ошибки типизации и компиляции**:
   - Запустите `npm run typecheck` для проверки ошибок TypeScript
   - Проверьте корректность импортов и типов
   - Обновите интерфейсы при изменении структуры данных

3. **Проблемы с Figma API**:
   - Проверьте ограничения Figma Plugin API (доступ к файлам, элементам и т.д.)
   - Используйте правильные методы для доступа к элементам
   - Обработайте ситуации, когда элементы не выбраны или имеют неподдерживаемый тип

## Рекомендации по разработке

### Наилучшие практики

1. **Управление состоянием**:
   - Используйте React State и Effect в UI компонентах
   - Храните настройки в Figma Client Storage для сохранения между сессиями
   - Разделяйте состояние UI и данные плагина

2. **Обработка ошибок**:
   - Всегда оборачивайте вызовы Figma API и WebSocket в try/catch
   - Отображайте информативные сообщения об ошибках пользователю
   - Реализуйте стратегии автоматического переподключения WebSocket

3. **Производительность**:
   - Оптимизируйте данные, отправляемые по WebSocket (только необходимые поля)
   - Используйте виртуализацию для отображения больших списков
   - Применяйте ленивую загрузку для компонентов по мере необходимости

4. **UX/UI**:
   - Следуйте дизайн-системе Figma
   - Предоставляйте визуальную обратную связь для длительных операций
   - Добавляйте подсказки и справочную информацию для сложных инструментов

### Типичные ловушки

1. **Переусложнение**:
   - Начинайте с минимально работающего функционала
   - Добавляйте функции постепенно
   - Тестируйте каждую новую функцию в изоляции

2. **Проблемы с совместимостью API**:
   - Всегда проверяйте документацию Figma Plugin API на наличие ограничений
   - Поддерживайте fallback-механизмы для несовместимых функций
   - Регулярно обновляйте код при обновлении Figma API

3. **Управление ожиданиями пользователя**:
   - Ясно указывайте, когда результаты генерируются AI
   - Предупреждайте о потенциальных ограничениях и проблемах
   - Обеспечьте возможность легкой модификации сгенерированных результатов

## План разработки

### Текущий статус (Март 2024)

- [x] Настройка инфраструктуры плагина
- [x] Базовое WebSocket-соединение с MCP-сервером
- [x] Компоненты пользовательского интерфейса (Header, Toolbar, Settings, Results)
- [x] Обработка выбранных элементов Figma
- [x] Реализация инструментов (анализ дизайна, генерация кода, адаптивные макеты, варианты)
- [x] Система управления настройками
- [ ] Тестирование и отладка в среде Figma
- [ ] Оптимизация и улучшение пользовательского опыта
- [ ] Подготовка к выпуску

### Следующие шаги

1. **Тестирование и отладка плагина**:
   - Тестирование в режиме разработки в Figma
   - Исправление ошибок типизации и интеграции с Figma API
   - Улучшение обработки ошибок и граничных случаев

2. **Улучшение пользовательского опыта**:
   - Добавление подсказок и руководства
   - Оптимизация рабочих процессов и потоков данных
   - Улучшение вывода результатов и интерактивности

3. **Подготовка к выпуску**:
   - Создание иконки и материалов для публикации
   - Написание документации для пользователей
   - Создание демонстрационных видео 